#!/usr/bin/env ruby

require 'json'

dependencies_regex = /dependencies\s+{[\s\S]*}/

dependency_metadata_regex =
  /((implementation)|(classpath))\s['|"](?<classpath>.*):(?<package>.*):(?<version>.+)['|"]/

dependency_lists = []

begin
  dependency_lists = File.read(ARGV[0]).scan(dependencies_regex)
rescue StandardError
  warn 'Unable to read and parse build.gradle file'
  exit(1)
end

dependencies = []

# Get contents within dependencies {}
dependency_lists.each do |dependency_list|
  # Parse individual dependency entry
  dependency_list.scan(dependency_metadata_regex).each do |dependency_properties|
    dependency_hash = {}
    dependency_hash[:classpath] = dependency_properties[0]
    dependency_hash[:package] = dependency_properties[1]
    dependency_hash[:version] = dependency_properties[2]
    dependencies.append(dependency_hash)
  end
end

if dependencies.empty?
  warn 'Could not parse dependencies from build.gradle file'
  exit(1)
end

puts dependencies.to_json
