#!/usr/bin/env ruby

require 'json'
require 'yaml'

podfile_lock = begin
  YAML.safe_load(File.read(ARGV[0]))
               rescue StandardError
                 warn 'Unable to parse Podfile.lock file'
                 exit(1)
end

if podfile_lock['PODS'].nil? || podfile_lock['DEPENDENCIES'].nil?
  warn '"PODS" or "DEPENDENCIES" key not found in Podfile.lock!'
  exit(1)
end

dependencies = []
# Parse individual dependency entry
(podfile_lock['PODS'] + podfile_lock['DEPENDENCIES']).each do |dependency_entry|
  dependency_properties = dependency_entry.split(' (')
  dependency_hash = {}
  dependency_hash[:pod] = dependency_properties[0].strip
  dependency_hash[:version] = dependency_properties[1].delete_suffix(')').strip
  dependencies.append(dependency_hash)
end

if dependencies.empty?
  warn 'No dependencies found in Podfile.lock!'
  exit(1)
end

puts dependencies.to_json
